---
layout: post
title: "RocketMQ原理-Broker存储模型"
date:   2022-10-08
tags: [RocketMQ]
comments: true
author: xy
# toc: true  # 这里加目录导致看到地方太小了
---

主要内容如下:

1. `RocketMQ` 顺序消息的使用场景

2. `RocketMQ` 同步异步刷盘

3. 生产者顺序消息需要注意的事项

### 1. `RocketMQ` 顺序消息的使用场景



### 2. `RocketMQ` 同步异步刷盘


两种模式枚举定义如下:

```java
public enum FlushDiskType {
    SYNC_FLUSH,
    ASYNC_FLUSH
}
```

broker此变量在message store配置中, 默认是异步

```java
public class MessageStoreConfig {
   ...
    private FlushDiskType flushDiskType = FlushDiskType.ASYNC_FLUSH;
}
```

`CommitLog`根据配置执行同步或者异步刷盘

```java
public class CommitLog{
public PutMessageResult putMessages(final MessageExtBatch messageExtBatch){
...
    handleDiskFlush(result, putMessageResult, messageExtBatch);
    handleHA(result, putMessageResult, messageExtBatch);
    return putMessageResult;
}

public void handleDiskFlush(AppendMessageResult result...){
    if (FlushDiskType.SYNC_FLUSH == defaultMessageStore.getMessageStoreConfig().getFlushDiskType()){
    ...同步刷盘
    }
...

```

### 参考


